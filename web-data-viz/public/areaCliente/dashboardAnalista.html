<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Servidores</title>
    <link rel="stylesheet" href="areaCliente.css" />
    <link rel="stylesheet" href="../css/areaCliente/notificacaoAlerta.css">
    <link rel="icon" href="../assets/TagTech/img/logo1.png" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <script src="../js/sessao.js"></script>
    <!-- boxIcons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <!-- AOS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Swiper -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/10.2.0/swiper-bundle.min.css"
        integrity="sha512-s6khMl5GDS1HbQ5/SwL1wzMayPwHXPjKoBN5kHUTDqKEPkkGyEZWKyH2lQ3YO2q3dxueG3rE0NHjRawMHd2b6g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="../js/alerta.js"></script>
</head>

<body onload="atualizacaoPeriodica()">
    <div class="header">
        <nav>
            <div class="menu">
                <a href="#home"><img src="../assets/TagTech/img/CarroNavBar.png" alt="logo" id="logo"></a>
                <span style="font-size: 40px; font-weight: bold; margin-left: 5%; color: white;">DashBoard Analista</span>
                <div class="alertaChamado" id="alertaJira" onclick="irParaAlertas()">
                    <img src="../assets/TagTech/dashboard-alerta/alertNotification.gif" alt="Ícone de Alerta">
                    <p id="pAlerta"></p>
                </div>
                <button class="menu-button"><i class='bx bx-menu'></i></button>
                <ul class="navbar">
                    <li><a href="gerenciar_servidor.html"><strong>Baixar relatório</strong></a></li>
                    <li><a href="gerenciar_servidor.html"><strong>Cadastro de Servidor</strong></a></li>
                    <li><a href="alerta.html"><strong>Alertas</strong></a></li>
                    <li><a href="index.html#cards"><strong>Help Desk</strong></a></li>
                    <li><a href="perfil.html"><strong>Perfil</strong></a></li>
                    <li style="color:black;"><strong>|</strong></li>
                    <li>
                        <a style="background-color: #fff178;" onclick="limparSessao()">
                            <strong>Sair <img src="../assets/icones/sair.svg" alt=""></strong>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="chart-container" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
            
            <div class="kpis">
                <div class="card-alertas">
                    <h2>Servidores em Alerta</h2>
                    <div id="alertas" style="font-size: 24px; font-weight: bold; margin-top: 10px;"></div>
                </div> 
                <div class="card-alertas">
                    <h3>Desvio Padrão Geral</h3>
                    <span id="desvio-padrao">Calculando...</span>
                </div>
            </div>

            <div class="ranking" style="width: 40%; height: 280px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; background-color: transparent;margin-right: 5%;">
                <h2>Filtros</h2>
                <select id="amostraTempo" onchange="alterarValores()">
                    <option selected disabled>Escolha a amostra</option>
                    <option value="dia">Dia</option>
                    <option value="semana">Semana</option>
                    <option value="mes">Mês</option>
                </select>
                <h3>Ranking de tempo fora do ar</h3>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table style="width: 100%;">
                        <tr>
                            <th>Ranking</th>
                            <th>Servidor</th>
                            <th>Tempo fora do ar (min)</th>
                        </tr>
                        <tr>
                            <td>1°</td>
                            <td>Servidor 2</td>
                            <td>53:03</td>
                        </tr>
                        <tr>
                            <td>2°</td>
                            <td>Servidor 1</td>
                            <td>45:23</td>
                        </tr>
                        <tr>
                            <td>3°</td>
                            <td>Servidor 3</td>
                            <td>36:12</td>
                        </tr>
                        <tr>
                            <td>4°</td>
                            <td>Servidor 4</td>
                            <td>29:45</td>
                        </tr>
                        <tr>
                            <td>5°</td>
                            <td>Servidor 5</td>
                            <td>22:39</td>
                        </tr>
                    </table>
                </div>
            </div>

            <canvas id="meuGrafico" style="aspect-ratio: 16/9; width: 40%; height: 280px; margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-left: 5%; "></canvas>
            <canvas id="horizontalBarChart" style="aspect-ratio: 16/9; width: 40%; height: 280px; margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-right: 5%;"></canvas>
        </div>
    </div>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <select id="filtroComponente">
        <option value="CPU">CPU</option>
        <option value="RAM">RAM</option>
        <option value="Disco">Disco</option>
    </select>
    
    </body>
</html>
    <script>
        // Declaração da variável para controle do timeout
      

        // Dados fictícios para os servidores
        const servidores = [
            { id: 1, alerta: true },
            { id: 2, alerta: true },
            { id: 3, alerta: false }
        ];

        // Atualizar o número de alertas no card
        function atualizarAlertas() {
            const totalServidores = servidores.length;
            const servidoresComAlerta = servidores.filter(s => s.alerta).length;
            document.getElementById('alertas').innerText = `${servidoresComAlerta}/${totalServidores}`;
        }

        // Chamada para atualizar o card na inicialização
        atualizarAlertas();
       
    let grafico;
    let proximaAtualizacao;

    // Função para obter os dados do gráfico via API
    function obterDadosGrafico(filtro = "CPU") {
        fetch(`/analisa/registros?idEmpresa&filtro=${filtro}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then((response) => response.json())
        .then((data) => {
            console.log("Dados recebidos:", data);
            plotarGrafico(data, filtro);
        })
        .catch((error) => {
            console.error("Erro ao buscar os dados:", error);
        });
    }

    // Função para plotar o gráfico
    function plotarGrafico(dados, filtro) {
        const labels = dados.map((registro) => `Máquina ${registro.idMaquina}`);
        const valores = dados.map((registro) => registro.percentual);

        const ctx = document.getElementById("meuGrafico").getContext("2d");

        // Limpa o gráfico anterior, se existente
        if (grafico) {
            grafico.destroy();
        }

        // Cria o gráfico atualizado
        grafico = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: `Uso de ${filtro}`,
                    data: valores,
                    borderColor: "rgba(75, 192, 192, 1)",
                    fill: false,
                }],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                },
            },
        });
    }

    // Função de atualização periódica
    function atualizacaoPeriodica() {
        const filtroComponente = document.getElementById("filtroComponente");
        if (!filtroComponente) {
            console.error("Elemento #filtroComponente não encontrado!");
            return;
        }

        const filtro = filtroComponente.value || "CPU"; // Valor padrão caso não exista um filtro selecionado
        obterDadosGrafico(filtro);

        // Configura nova chamada de atualização após 2 segundos
        proximaAtualizacao = setTimeout(atualizacaoPeriodica, 2000);
    }

    // Evento para iniciar atualização quando o filtro for alterado
    document.getElementById("filtroComponente").addEventListener("change", atualizacaoPeriodica);

    // Inicia a atualização periódica após o carregamento da página
    document.addEventListener("DOMContentLoaded", () => {
        atualizacaoPeriodica();
    });
</script>


