<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Servidores</title>
    <link rel="stylesheet" href="areaCliente.css" />
    <link rel="stylesheet" href="../css/areaCliente/notificacaoAlerta.css">
    <link rel="icon" href="../assets/TagTech/img/logo1.png" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <script src="../js/sessao.js"></script>
    <!-- boxIcons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <!-- AOS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Swiper -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/10.2.0/swiper-bundle.min.css"
        integrity="sha512-s6khMl5GDS1HbQ5/SwL1wzMayPwHXPjKoBN5kHUTDqKEPkkGyEZWKyH2lQ3YO2q3dxueG3rE0NHjRawMHd2b6g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Carregar a biblioteca ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="../js/alerta.js"></script>
</head>

<body onload="iniciarDashboard()">
    <div class="header">
 <nav>
            <div class="menu">
                <a href="#home"><img src="../assets/TagTech/img/CarroNavBar.png" alt="logo" id="logo"></a>
            
                <div class="alertaChamado" id="alertaJira" onclick="irParaAlertas()">
                    <img src="../assets/TagTech/dashboard-alerta/alertNotification.gif" alt="Ícone de Alerta">
                    <p id="pAlerta"></p>
                </div>
                <button class="menu-button"><i class='bx bx-menu'></i></button>
                <ul class="navbar">
                    <li><a href="gerenciar_servidor.html"><strong>Baixar relatório</strong></a></li>
                    <li><a href="gerenciar_servidor.html"><strong>Cadastro de Servidor</strong></a></li>
                    <li><a href="alerta.html"><strong>Alertas</strong></a></li>
                    <li><a href="index.html#cards"><strong>Help Desk</strong></a></li>
                    <li><a href="perfil.html"><strong>Perfil</strong></a></li>
                    <li style="color:black;"><strong>|</strong></li>
                    <li>
                        <a style="background-color: #fff178;" onclick="limparSessao()">
                            <strong>Sair <img src="../assets/icones/sair.svg" alt=""></strong>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
            </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="chart-container" style="display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap;">
            <div class="kpis" style="display: flex; flex-direction: row; gap: 20px;">
                <div class="card-alertas">
                    <h2>Servidores em Alerta</h2>
                    <div id="alertas" style="font-size: 24px; font-weight: bold; margin-top: 10px;"></div>
                </div> 
                <div class="card-alertas">
                    <h3>Desvio Padrão Geral</h3>
                    <span id="desvio-padrao" style="font-size: 24px; font-weight: bold;"></span>
                </div>
            </div>

            <div class="ranking" style="width: 40%; height: 280px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; background-color: transparent;margin-right: 5%;">
                <h2>Filtros</h2>
                <select id="amostraTempo" onchange="alterarValores()">
                    <option selected disabled>Escolha a amostra</option>
                    <option value="dia">Dia</option>
                    <option value="semana">Semana</option>
                    <option value="mes">Mês</option>
                </select>
                <h3>Ranking de tempo fora do ar</h3>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table style="width: 100%;">
                        <tr>
                            <th>Ranking</th>
                            <th>Servidor</th>
                            <th>Tempo fora do ar (min)</th>
                        </tr>
                        <tr>
                            <td>1°</td>
                            <td>Servidor 2</td>
                            <td>53:03</td>
                        </tr>
                        <tr>
                            <td>2°</td>
                            <td>Servidor 1</td>
                            <td>45:23</td>
                        </tr>
                        <tr>
                            <td>3°</td>
                            <td>Servidor 3</td>
                            <td>36:12</td>
                        </tr>
                        <tr>
                            <td>4°</td>
                            <td>Servidor 4</td>
                            <td>29:45</td>
                        </tr>
                        <tr>
                            <td>5°</td>
                            <td>Servidor 5</td>
                            <td>22:39</td>
                        </tr>
                    </table>
                 </div>
              </div>
         <div class="charts" style="width: 40%; height: 280px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; background-color: transparent;margin-left: 5%; margin-top: 20px;">
            <h3>Uso dos componentes (por servidor)</h3>
            <label for="componente">Selecione o Componente:</label>
          <select id="componente">
            <option value="CPU">CPU</option>
            <option value="RAM">RAM</option>
            <option value="DISCO">DISCO</option>
           </select>
           
            <div id="grafico">

            </div>
        </div>

        <div class="charts" style="width: 40%; height: 280px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; background-color: transparent;margin-right: 5%; margin-top: 20px;">
            <h3>Variância de cada componente (por servidor)</h3>
            <label for="componente-maxmin">Selecione o Componente:</label>
            <select id="componente-maxmin">
                <option value="CPU">CPU</option>
                <option value="RAM">RAM</option>
                <option value="DISCO">DISCO</option>
            </select>
            <div id="grafico-maxmin"></div>
        </div>

    </div>
</div> 
    <script>
        window.onload = function() {
            let grafico;
            let servidores = {}; // Armazenar os dados de cada servidor
            let graficoMaxMin; // Gráfico de máximo e mínimo

            async function fetchData(componente) {
                const response = await fetch(`http://localhost:3333/analistadados/${componente}`);
                return response.json();
            }

            function atualizarGrafico(dados, componente) {
                // Atualiza os dados armazenados para cada servidor
                dados.forEach(d => {
                    servidores[d.idMaquina] = d.valor;
                });

                // Preparando as novas séries para o gráfico
                const labels = Object.keys(servidores).map(id => `Servidor ${id}`);
                const valores = Object.values(servidores);

                const options = {
                    chart: {
                        type: 'bar',
                        height: 280, // Ajustando o tamanho do gráfico
                    },
                    series: [{
                        name: `Uso de ${componente}`,
                        data: valores
                    }],
                    xaxis: {
                        categories: labels, // Servidores no eixo X
                    },
                    yaxis: {
                        title: {
                            text: `${componente} (%)`
                        },
                        min: 0,
                        max: 100,
                    }
                };

                if (grafico) {
                    grafico.updateOptions(options); // Atualiza o gráfico existente
                } else {
                    grafico = new ApexCharts(document.querySelector("#grafico"), options);
                    grafico.render();
                }
            }

            document.getElementById('componente').addEventListener('change', async (e) => {
                const componente = e.target.value;
                const dados = await fetchData(componente);
                atualizarGrafico(dados, componente);
            });

            // Atualizar gráfico a cada 2 segundos
            setInterval(async () => {
                const componente = document.getElementById('componente').value;
                const dados = await fetchData(componente);
                atualizarGrafico(dados, componente);
            }, 1000);
        
         // Função para buscar os dados de máximo e mínimo
         async function fetchMaxMinData(componente) {
            const response = await fetch(`http://localhost:3333/analistadados/${componente}/maxmin`);
            return response.json();
        }

        // Função para criar ou atualizar o gráfico de máximos e mínimos
        function criarGraficoMaxMin(dados, componente) {
            const labels = dados.map(d => `Servidor ${d.idMaquina}`); // Eixo Y
            const maxValores = dados.map(d => parseFloat(d.maxValor) || 0); // Valores Máximos
            const minValores = dados.map(d => parseFloat(d.minValor) || 0); // Valores Mínimos

            const options = {
                chart: {
                    type: 'bar',
                    height: 280,
                },
                series: [
                    { name: `Máximo de ${componente}`, data: maxValores },
                    { name: `Mínimo de ${componente}`, data: minValores },
                ],
                plotOptions: {
                    bar: {
                        horizontal: true, // Barras horizontais
                        barHeight: '50%',
                    },
                },
                xaxis: {
                    title: {
                        text: `${componente} (%)`,
                    },
                    min: 0,
                    max: 100, // Ajusta o eixo X entre 0 e 100%
                },
                yaxis: {
                    categories: labels, // Nomes dos servidores no eixo Y
                },
                dataLabels: {
                    enabled: false, // Desativado para melhorar a performance
                },
                colors: ['#FF4560', '#00E396'], // Cores para Máximo e Mínimo
            };

            if (graficoMaxMin) {
                graficoMaxMin.updateOptions(options); // Atualiza o gráfico existente
            } else {
                graficoMaxMin = new ApexCharts(document.querySelector("#grafico-maxmin"), options);
                graficoMaxMin.render();
            }
        }

        // Atualizar o gráfico de máximos e mínimos ao selecionar um componente
        document.getElementById('componente-maxmin').addEventListener('change', async (e) => {
            const componente = e.target.value;
            const dados = await fetchMaxMinData(componente);
            criarGraficoMaxMin(dados, componente);
        });

        // Atualização periódica do gráfico de máximos e mínimos
        setInterval(async () => {
            const componenteMaxMin = document.getElementById('componente-maxmin').value;
            if (componenteMaxMin) {
                const maxMinDados = await fetchMaxMinData(componenteMaxMin);
                criarGraficoMaxMin(maxMinDados, componenteMaxMin);
            }
        }, 1000);

        async function fetchDesvioPadraoGlobal() {
    const response = await fetch("http://localhost:3333/analistadados/desviopadrao");
    return response.json();
}

async function atualizarDesvioPadraoGlobal() {
    try {
        const dados = await fetchDesvioPadraoGlobal();
        const desvioPadrao = dados.desvioPadraoGlobal || 0;
const desvioPadraoExibido = desvioPadrao < 0.01 ? '0.01' : desvioPadrao.toFixed(2); // Exibe no mínimo 0.01
document.getElementById("desvio-padrao").textContent = desvioPadraoExibido;

    } catch (error) {
        console.error("Erro ao atualizar desvio padrão global:", error);
    }
}

// Atualizar o desvio padrão global a cada 2 segundos
setInterval(atualizarDesvioPadraoGlobal, 1000);

// Atualizar ao carregar a página
atualizarDesvioPadraoGlobal();

   
    };
    </script>
</body>
</html>