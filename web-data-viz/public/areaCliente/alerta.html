<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tag | Alertas</title>

    <script src="../js/sessao.js"></script>


    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/areaCliente/alerta.css" />


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

            <!-- boxIcons -->
            <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
            <!-- AOS -->
            <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
            <!-- Swiper -->
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/10.2.0/swiper-bundle.min.css"
                integrity="sha512-s6khMl5GDS1HbQ5/SwL1wzMayPwHXPjKoBN5kHUTDqKEPkkGyEZWKyH2lQ3YO2q3dxueG3rE0NHjRawMHd2b6g=="
                crossorigin="anonymous" referrerpolicy="no-referrer" />
                <!-- Adicionando o estilo pointer ao botão "Sair" -->
                <style>
                  .navbar li a[onclick="limparSessao()"] {
                      cursor: pointer;
                  }
              </style>

            <link rel="icon" href="../assets/TagTech/img/logo1.png" />
  </head>
  <body onload="direcionarDashboard(), getChamados()">
    <div class="container">

      <header>
        
        <nav>
          <div class="menu">
            <a href="#home"
              ><img
                src="../assets/TagTech/img/CarroNavBar.png"
                alt="logo"
                id="logo"
            /></a>
            <div class="alertaChamado">
              <img src="../assets/TagTech/dashboard-alerta/alertNotification.gif" alt="Ícone de Alerta">
              <p>Alerta: <br> servidor 5 fora do ar!</p>
            </div>
            
            <button class="menu-button"><i class="bx bx-menu"></i></button>

            <ul class="navbar">
              <li>
                <a id="dashboardLink"><strong>Dashboard</strong></a>
              </li>
              <li>
                <a href="alerta.html"><strong>Alertas</strong></a>
              </li>
              <li>
                <a href="#"><strong>Help Desk</strong></a>
              </li>
              <li>
                <a href="perfil.html"><strong>Perfil</strong></a>
              </li>
              <li style="color: black"><strong>|</strong></li>
              <li>
                <a 
                  onclick="limparSessao()"
                  style="background-color: #fff178"
                  ><strong
                    >Sair <img src="../assets/icones/sair.svg" alt="" /></strong
                ></a>
              </li>
            </ul>
          </div>
        </nav>
      </header>

      <main>
        <section class="graficosAlerta">
          <div class="containerAlertasTop">
            <div class="graficoBarrasTipoAlerta grafAlerta">
              <canvas
                id="horizontalBarChart"
                class="canvasBarra"
              ></canvas>
            </div>
            <div class="graficoRoscaTipoAlerta grafAlerta">
              <canvas
                class="canvasRosca"
                id="RoscaChart"

              ></canvas>
            </div>
          </div>
          <div class="graficoAlertaPorTempo grafAlerta">
            <canvas 
              class="canvasLinha"
              id="LineChart"
            ></canvas>
          </div>
        </section>

        <section class="containerAlertas">
          <div class="divAlertas">
            <div class="headerAlertas">
              <h2>Histórico de Alertas</h2>
              <h4>Chamados (5 resultados) (Ultimas 24 horas)</h4>
            </div>

            <table id="tabelaDeAlertas">
              <thead>
                <tr>
                  <th>id do chamado</th>
                  <th>Servidor</th>
                  <th>Situação</th>
                  <th>Componente</th>
                  <th>Tipo de incidente</th>
                  <th>% de uso</th>
                  <th>Horário</th>
                </tr>
              </thead>
              <tbody id="bodyTabela">
                
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </body>
</html>

<script>


  var listaDeChaves = []



  var listaChamadosPico = []
  var listaPorcentagens = []
  var listaComponentes = []
  var listaDatas = []
  var listaServidores = []



  var listaChamadosDown = []
  var listaDatasDown = []
  var listaServidoresDown = []

  async function getChamados(){

  listaChamadosPico = []
  listaChamadosDown = []
  listaDeChaves = []
    const response = await fetch("/verChamados", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    });

    const data = await response.json();
     // Exibe a resposta completa
    
    // Acessando o array de issues
    const issues = data.resultado.issues; // Aqui estamos acessando o array de issues
    
    console.log(issues)

    // Processando as issues
    issues.forEach(issue => {
      const chamadoAtual = issue.fields; // Acesse os campos do issue
      const descAtual = chamadoAtual.description; // Supondo que você tenha um campo 'description'
      
      var tipoChamado = chamadoAtual.project.key;

      listaDeChaves.push(issue.key)

      console.log(chamadoAtual)

      console.log(tipoChamado)
      console.log(descAtual);
      if(tipoChamado == "TTCS"){
        listaChamadosPico.push(descAtual)
      }else if(tipoChamado == "DOWN"){
        listaChamadosDown.push(descAtual)
      }

      
    });

    dadosChamados()





  }


  function dadosChamados(){
    listaChamadosPico.forEach(chamado => {


      var index = chamado.indexOf("´´");
      if (index !== -1) {  // Verifica se "´´" foi encontrado
          var porcentAtual = chamado.substring(index + 2, index + 6);
          listaPorcentagens.push(Number(porcentAtual))
      }


      index = chamado.indexOf("**");
      if (index !== -1) { 
          var dataAtual = chamado.substring(index + 2, index + 19);

          dataAtual = new Date(dataAtual) 

          listaDatas.push(dataAtual)

      }


      index = chamado.indexOf("teve");
      if (index !== -1) {  
          var componenteAtual = chamado.substring(13, index - 1);
          listaComponentes.push(componenteAtual)

      }


      index = chamado.indexOf("''");
      if (index !== -1) {  
          var servidorAtual = chamado.substring(index + 2);
          listaServidores.push(servidorAtual)

      }

      console.log(porcentAtual)
      console.log(dataAtual)
      console.log(componenteAtual)
      console.log(servidorAtual)

      

  });

  listaChamadosDown.forEach(chamado => {
    index = chamado.indexOf("**");
    if (index !== -1) { 
        var dataAtual = chamado.substring(index + 2, index + 19);

        dataAtual = new Date(dataAtual) 
        listaDatasDown.push(dataAtual)

    }

    index = chamado.indexOf("''");

    index2 = chamado.indexOf("ficou")
    if (index !== -1) {  
        var servidorAtual = chamado.substring(index +2,  index2  );
        listaServidoresDown.push(servidorAtual)

    }


  })

  plotarGraficos()

  }



  function plotarGraficos(){

    var picoCPU = 0
    var picoDisco = 0
    var picoRAM = 0

    listaComponentes.forEach(componente =>{
      console.log(componente)

      if(componente == 'CPU') picoCPU ++;
      if(componente == 'disco') picoDisco ++;
      if(componente == 'memória RAM') picoRAM ++;
      
      
      })


    const ctxBar = document.getElementById("horizontalBarChart").getContext("2d");
    const dataBar = {
      labels: ["CPU", "RAM", "DISCO"],
      datasets: [
        {
          label: "DOWN TIME",
          data: [listaChamadosDown.length, listaChamadosDown.length, listaChamadosDown.length],
          borderColor: "rgb(255, 99, 132)",
          backgroundColor: "#ff914c",
        },
        {
          label: "SOBRECARGA",
          data: [picoCPU, picoRAM, picoDisco],
          backgroundColor: "#f64b00",
        },
      ],
    };
  


    const configBar = {
      type: "bar",
      data: dataBar,
      options: {
        indexAxis: "x", // Configuração para barras horizontais
        elements: {
          bar: {
            borderWidth: 2,
          },
        },
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom", // Muda a posição da legenda para baixo
          },
          title: {
            display: true,
            text: "Distribuição de alerta por componente",
          },
        },
      },
    };
  
    const horizontalBarChart = new Chart(ctxBar, configBar);

    
    const dataNivelCritico = contarPorDiaDaSemana(listaDatas);
    const dataDownTimes = contarPorDiaDaSemana(listaDatasDown);

  
    const ctxLine = document.getElementById("LineChart").getContext("2d");
  
    const dataLine = {
      labels: [
        "Domingo",
        "Segunda",
        "Terça",
        "Quarta",
        "Quinta",
        "Sexta",
        "Sabado",
      ],
      datasets: [
        {
          label: "Nivel Critico",
          data: dataNivelCritico,
          borderColor: "rgb(255, 99, 132)",
          backgroundColor: "#ff914c",
        },
        {
          label: "Down Times",
          data: dataDownTimes,
          borderColor: "blue",
          backgroundColor: 'blue"',
        },
      ],
    };
  
    const configLine = {
      type: "line",
      data: dataLine,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "top",
          },
          title: {
            display: true,
            text: "Alertas por dia de semana",
          },
        },
      },
    };
    const LineChart = new Chart(ctxLine, configLine);
  
    const ctxRosca = document.getElementById("RoscaChart").getContext("2d");
  
    

    const dataRosca = {
      labels: ["Critico", "DownTime"],
      datasets: [
        {
          label: "Dataset 1",
          data: [listaChamadosPico.length, listaChamadosDown.length],
          backgroundColor: ["red", "orange"],
        },
      ],
    };
  
    const configRosca = {
      type: "doughnut",
      data: dataRosca,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "top",
          },
          title: {
            display: true,
            text: "Tipos de alerta",
          },
        },
      },
    };
  
    const RoscaChart = new Chart(ctxRosca, configRosca);

    incrementarTabela()

  }

  function contarPorDiaDaSemana(lista) {
    const diasDaSemana = Array(7).fill(0); // Cria um array com 7 zeros, um para cada dia da semana
  
    lista.forEach((data) => {
      const diaSemana = data.getDay(); // getDay() retorna o dia da semana (0 = Domingo, 6 = Sábado)
      diasDaSemana[diaSemana] += 1;
    });
  
    return diasDaSemana;



  }

  function formatarData(data) {
    const opcoesData = {
      weekday: "long",
      day: "numeric",
      month: "long",
      year: "numeric",
    };
  
    const dataFormatada = data.toLocaleDateString("pt-BR", opcoesData);
    const horaFormatada = data.toLocaleTimeString("pt-BR", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: true,
    });
  
    return `${dataFormatada} ${horaFormatada}`;
  }
  
  const dataAtual = new Date();
  console.log(formatarData(dataAtual));


  function incrementarTabela(){

   

    for(var i = 0; i < listaChamadosPico.length; i++ ){

      var dataFormatada = formatarData(listaDatas[i])

      bodyTabela.innerHTML += 
      
      `
                <tr>
                  <td>${listaDeChaves[i]}</td>
                  <td>${listaServidores[i]}</td>
                  <td>Esperando Suporte</td>
                  <td>${listaComponentes[i]}</td>
                  <td>Nivel Crítico</td>
                  <td>${listaPorcentagens[i]}%</td>
                  <td>${dataFormatada}</td>
                </tr>
      `;
    }


    for(var i = 0; i < listaChamadosDown.length; i++ ){

      var dataFormatada = formatarData(listaDatasDown[i])

      bodyTabela.innerHTML += 
      
      `
                <tr>
                  <td>${listaDeChaves[i + listaChamadosPico.length]}</td>
                  <td>${listaServidoresDown[i]}</td>
                  <td>Esperando Suporte</td>
                  <td>Todos</td>
                  <td>Down Time</td>
                  <td>0%</td>
                  <td>${dataFormatada}</td>
                </tr>
      `;
    }


  }
  

</script>

<script>
  //menu hamburguer
  const menuButton = document.querySelector('.menu-button');
  const navbar = document.querySelector('.navbar');

  menuButton.addEventListener('click',
      () => {
          navbar.classList.toggle('active');

      });
</script>
