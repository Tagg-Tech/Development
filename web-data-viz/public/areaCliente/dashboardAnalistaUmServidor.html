<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Servidor</title>
    <link rel="stylesheet" href="../css/areaCliente/AnalistaUmServidor.css" />
    <!-- favIcon -->
    <script src="../js/alerta.js"></script>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/areaCliente/notificacaoAlerta.css">
    <link rel="shortcut icon" href="../assets/TagTech/img/logo1.png" type="image/x-icon">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>

                <!-- boxIcons -->
                <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
                <!-- AOS -->
                <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
                <!-- Swiper -->
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/10.2.0/swiper-bundle.min.css"
                    integrity="sha512-s6khMl5GDS1HbQ5/SwL1wzMayPwHXPjKoBN5kHUTDqKEPkkGyEZWKyH2lQ3YO2q3dxueG3rE0NHjRawMHd2b6g=="
                    crossorigin="anonymous" referrerpolicy="no-referrer" />
                 <!-- Adicionando o estilo pointer ao botão "Sair" -->
                    <style>
                        .navbar li a[onclick="limparSessao()"] {
                            cursor: pointer;
                        }
                    </style>

                <link rel="icon" href="../assets/TagTech/img/logo1.png" />
                <script src="../js/sessao.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.4.0/dist/chartjs-plugin-datalabels.min.js"></script>


</head>

<body onload=" atualizacaoPeriodica(), graficoDinamico()">
    <div class = "container_" >
        <div class="header">
            <nav>
                <div class="menu">
                    <a href="#home"><img src="../assets/TagTech/img/CarroNavBar.png" alt="logo" id="logo"></a>
                    <span style="font-size: 40px; position: fixed; font-weight: bold; left: 15%; top: 1%; color: white;">Dashboard Analista</span>
                    <div class="alertaChamado" id="alertaJira" onclick="irParaAlertas()">
                        <img src="../assets/TagTech/dashboard-alerta/alertNotification.gif" alt="Ícone de Alerta">
                        <p id="pAlerta"></p>
                    </div>
                    <button class="menu-button"><i class='bx bx-menu'></i></button>

                    <ul class="navbar">
                        <li><a href="dashboardAnalista.html"><strong>Dashboard</strong></a></li>
                        <li><a href="alerta.html"><strong>Alertas</strong></a></li>
                        <li><a href="https://tagtech.atlassian.net/jira/servicedesk/projects/THD/issues?jql=project%20%3D%20%22THD%22%20ORDER%20BY%20created%20DESC" target="blank"><strong>Help Desk</strong></a></li>
                        <li><a href="perfil.html"><strong>Perfil</strong></a></li>
                        <li style="color:black;"><strong>|</strong></li>
                        <li><a style="background-color: #fff178;" onclick="limparSessao()"><strong>Sair <img src="../assets/icones/sair.svg" alt=""></strong></a></li>
                    </ul>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Div para as métricas acima dos gráficos -->
            <div class="up-side-dash">

                <!-- Métrica 1 -->
                <div class = "metrica-um" >
                    <div class = "sub-metrica-um">
                        <div class = "titulo-sub-metrica-um" >
                            Selecione o intervalo
                            desejado
                        </div>
                        <select name="" id="">
                            <option value="" selected disabled>Período</option>
                            <option value="">Dia</option>
                            <option value="">Semana</option>
                            <option value="">Mês</option>
                        </select>
                    </div>
                    <div class = "sub-metrica-um-parte2">
                        <div class = "div-picos-1" >Número de picos</div>
                        <div class = "valor-pico-1">3</div>
                    </div>
                </div>

                <!-- Métrica 2 -->
                <div class = "metrica-dois" >
                    <div class = "div-picos-2" >RAM</div>
                    <div class = "valor-pico-2" >
                        <span id="atual_ram" ></span>
                        <span>/</span>
                        <span id="maximo_ram"></span>
                    </div>
                </div>

                <!-- Métrica 3 -->
                 <div class="metrica-tres" >
                    <div class = "div-picos-3" >Estado atual</div>
                    <div class = "valor-pico-3" >Estável</div>
                 </div>

            </div>

            <!-- Container flexbox para os gráficos -->
            <div class="chart-container">

                <!-- Gráfico de Pizza -->
                <canvas id="meuGrafico"
                style="aspect-ratio: 16/9; 
                               width: 45%; 
                            height: 280px;  
                 border: 1px solid #ddd; 
                      border-radius: 10px;">

                </canvas>
                <!-- Gráfico de Linhas -->
                <canvas id="LineChart" 
                    style="aspect-ratio: 16/9; 
                                   width: 45%; 
                                height: 280px; 
                     border: 1px solid #ddd; 
                          border-radius: 10px;">
                </canvas>  

            </div>

        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
               let fk_maquina = sessionStorage.getItem('fk_maquina');
               let id_usuario = sessionStorage.getItem('ID_USUARIO');
        //--------------Gráfico de linhas------------------------------------//
        //Instanciando gráfico de linahs
        let ctxLine = document.getElementById("LineChart").getContext("2d");

        //Corpo do gráfico de linhas
        let graficoLinha = new Chart(
            ctxLine, {
                type: "line",
                data: {
                    // labels: [1, 2, 3],
                    datasets: [
                        {
                            label: "",
                            // data: [4, 5, 6],
                            borderColor: "#fe914c",
                            color: 'black',
                            backgroundColor: "#fe914c",
                        },
                        {
                            label: "",
                            // data: [7, 8, 9],
                            borderColor: "#8b5736",
                            backgroundColor: "#8b5736",
                        },
                    ],
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: "top",
                            labels: {
                                font: { size: 18 },
                                color: 'black'
                            },
                        },
                        title: {
                            display: true,
                            text: "Uso de CPU e RAM (%)",
                            font: { size: 24 },
                            padding: { bottom: 30 },
                            color: 'black'
                        },
                    },
                },
            }
        );

        //arrays que vão armazenar os dados vindos do banco para compor o gráfico de linhas
        let listaDadosHora = [];
        let percentuaisCPU = [];
        let percentuaisRAM = [];

        //--------------Gráfico de linhas-------------------------------------------------//

        //--------------------------------------------------------------------------------//

        //--------------Gráfico de pizza-------------------------COMEÇO--------------------//

        let ctxPizza = document.getElementById('meuGrafico').getContext('2d');
        //Corpo do gráfico de pizza
        let meuGrafico = new Chart(ctxPizza, {
            type: 'pie',
            data: {
                // labels: ['Livre','Ocupado'],
                datasets: 
                [
                    {
                        // data: [90,10],
                        backgroundColor: ["#fe914c","#8b5736"],
                    }
                ]
            },
            options: {
                tooltips:{
                    enable: true,
                },
                plugins: {
                    datalabels: {
                        formatter: (value, ctx) => {
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data[0];
                            dataArr.map(data => {
                                 sum += data;
                         });
                        let percentage = (value*100 / sum).toFixed(2)+"%";
                        return percentage;
                    },
                    },
                    legend: {
                        position: 'left',
                        labels: {
                            font: { 
                                size: 21,
                                wight: 'bold' 
                            },
                            color: 'black'
                        },
                    },
                    title: {
                        display: true,
                        text: 'Disco Usado x Livre (%)',
                        font: { size: 24 },
                        padding: { bottom: 30 },
                        color: 'black'
                    }
                },
                responsive: false,
                maintainAspectRatio: true
            },
        });    

        //--------------Gráfico de pizza-------------------FIM----------------------------//

        //valores temporários atribuidos para testes
 
        // let fk_maquina = sessionStorage.getItem('FK_MAQUINA');
        // let id_usuario = sessionStorage.getItem('ID_USUARIO');
        
        //função para atualizar os valores plotados no gráfico de linhas e pizza
        function graficoDinamico() {

            //------------------------Gráfico de linhas---------------------------------//

            //fetch para trazer os dados do banco do grafico de linhas
            fetch(`../servidor/pegarCpuRamPorcentagem`, {
                method: 'POST',
                body: JSON.stringify({
                    idUsuarioServer: id_usuario,
                    fkMaquinaServer: fk_maquina
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then((response) => {
                if(!response.ok) {
                    throw new Error("rede n ok")
                }
                response.json().then(dados => {
                    //mapeando a primeira coluna
                    const valoresCPU = dados.map(dado => dado.percentualCPU);
                    //mapeando a segunda coluna
                    const valoresMemoria = dados.map(dado => dado.percentualMemoria);

                    //pegando o ultimo valor da coluna CPU
                    ultimoValorCPU = valoresCPU[valoresCPU.length - 1]
                    ultimoValorRAM = valoresMemoria[valoresMemoria.length - 1]

                    //colocando os ultimos 5 valores da cpu num array
                    percentuaisCPU.push(ultimoValorCPU)
                    percentuaisRAM.push(ultimoValorRAM)

                    //preparando o grafico para guardar 5 valores
                    if (listaDadosHora.length > 5) {
                        percentuaisCPU.shift();
                        percentuaisRAM.shift();
                        listaDadosHora.shift();
                    }

                    //Compondo o corpo do gráfico com os valores puxados do banco
                    graficoLinha.data.labels = listaDadosHora;
                    graficoLinha.data.datasets[0].data = percentuaisCPU;
                    graficoLinha.data.datasets[1].data = percentuaisRAM;
                    graficoLinha.data.datasets[0].label = "CPU: " + ultimoValorCPU + " %";
                    graficoLinha.data.datasets[1].label = "RAM: " + ultimoValorRAM + " %";
                    graficoLinha.update();
                });
            })
            .catch(error => {
                console.error('Erro ao enviar os dados:', error);
            }); 

            //eixo X do gráfico de linhas com hora atual
            listaDadosHora.push(new Date().toLocaleTimeString());

            //------------------------Gráfico de linhas---------------------------------//

            //------------------------Gráfico de pizza---------------------------------//

            fetch(`../servidor/pegarUsoDisco`, {
                method: 'POST',
                body: JSON.stringify({
                    idUsuarioServer: id_usuario,
                    fkMaquinaServer: fk_maquina
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then((response) => {
                if(!response.ok) {
                    throw new Error("rede n ok")
                }
                response.json().then(dados => {
                    //mapeando a primeira coluna
                    const atualDisco = dados.map(dado => dado.percentualDisco);

                    //pegando o ultimo valor da coluna do disco
                    ultimoValorDisco = atualDisco[atualDisco.length - 1]

                    //cálculo para espaço livre
                    let espaco_livre = 100 - ultimoValorDisco;

                    //Compondo o corpo do gráfico com os valores puxados do banco
                    meuGrafico.data.datasets[0].data[0] = espaco_livre;
                    meuGrafico.data.datasets[0].data[1] = ultimoValorDisco;
                    meuGrafico.data.labels[0] = "Livre: " + espaco_livre + " %";
                    meuGrafico.data.labels[1] = "Ocupado: " + ultimoValorDisco + " %";
                    meuGrafico.update();
                });
            })
            .catch(error => {
                console.error('Erro ao enviar os dados:', error);
            }); 

            //------------------------Gráfico de pizza---------------------------------//

            //------------------------KPI RAM------------------INÍCIO------------------//

            fetch(`../servidor/pegarRAM`, {
                method: 'POST',
                body: JSON.stringify({
                    fkMaquinaServer: fk_maquina
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then((response) => {
                if(!response.ok) {
                    throw new Error("rede n ok")
                }
                response.json().then(dados => {
                    //mapeando a primeira coluna
                    const atualRAM = dados.map(dado => dado.gigaBytesMemoria);
                    const maxRAM = dados.map(dado => dado.qtdTotalRAM);

                    //pegando o ultimo valor da coluna de RAM
                    ultimoValorAtualRAM = atualRAM[atualRAM.length - 1]
                    maximoRAMServidor = maxRAM[maxRAM.length - 1]
                    console.log("ram atual: ", ultimoValorAtualRAM);
                    

                    //Transformando o total de ram de MB para GB
                    let ramEmGB = (maximoRAMServidor / 1000).toFixed(2);
                    console.log("ram max: ", ramEmGB);

                    //Cálculo de alteração de cor 
                    let limite = (ultimoValorAtualRAM / ramEmGB) * 100;

                    //Mostrando no html
                    let showRAMAtual = document.getElementById('atual_ram');

                    if(limite >= 80){
                        showRAMAtual.innerHTML = ultimoValorAtualRAM; 
                        showRAMAtual.style.color = 'red';   
                    } else {
                        showRAMAtual.innerHTML = ultimoValorAtualRAM;
                        showRAMAtual.style.color = 'black'; 
                    }

                    let showRAMMax = document.getElementById('maximo_ram');
                    showRAMMax.innerHTML = ramEmGB;

                    //Plotando no HTML
                });
            })
            .catch(error => {
                console.error('Erro ao enviar os dados:', error);
            });             

            //------------------------KPI RAM--------------------FIM-------------------//
        
            // Schedule next update
            setTimeout(graficoDinamico, 3000);
        }

    </script>
</body>
</html>
